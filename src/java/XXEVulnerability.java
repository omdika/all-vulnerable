package java;

import javax.xml.parsers.*;
import org.xml.sax.*;
import org.w3c.dom.*;
import java.io.*;

/**
 * XML External Entity (XXE) vulnerabilities.
 * Used for testing SAST tools.
 */
public class XXEVulnerability {

    /**
     * Vulnerable XML parsing with DocumentBuilderFactory
     */
    public Document parseXMLVulnerable(String xmlData) throws Exception {
        // VULNERABLE: DocumentBuilderFactory with external entities enabled
        DocumentBuilderFactory factory = DocumentBuilderFactory.newInstance();

        // These settings make the parser vulnerable
        factory.setNamespaceAware(true);
        factory.setExpandEntityReferences(true); // Dangerous

        DocumentBuilder builder = factory.newDocumentBuilder();

        // Parse XML from string
        InputSource is = new InputSource(new StringReader(xmlData));
        return builder.parse(is);
    }

    /**
     * Vulnerable XML parsing with SAXParser
     */
    public void parseXMLWithSAXVulnerable(String xmlData) throws Exception {
        // VULNERABLE: SAXParser with external entities
        SAXParserFactory factory = SAXParserFactory.newInstance();
        SAXParser parser = factory.newSAXParser();

        XMLReader reader = parser.getXMLReader();
        reader.parse(new InputSource(new StringReader(xmlData)));
    }

    /**
     * Vulnerable XML parsing with external DTD
     */
    public Document parseWithExternalDTD(String xmlData) throws Exception {
        // VULNERABLE: Allowing external DTD
        DocumentBuilderFactory factory = DocumentBuilderFactory.newInstance();

        // These are the dangerous settings
        factory.setFeature("http://xml.org/sax/features/external-general-entities", true);
        factory.setFeature("http://xml.org/sax/features/external-parameter-entities", true);

        DocumentBuilder builder = factory.newDocumentBuilder();
        InputSource is = new InputSource(new StringReader(xmlData));
        return builder.parse(is);
    }

    /**
     * XML parsing that disables XXE
     */
    public Document parseXMLSafe(String xmlData) throws Exception {
        // SAFE: Disabling external entities
        DocumentBuilderFactory factory = DocumentBuilderFactory.newInstance();

        // These features disable XXE
        factory.setFeature("http://apache.org/xml/features/disallow-doctype-decl", true);
        factory.setFeature("http://xml.org/sax/features/external-general-entities", false);
        factory.setFeature("http://xml.org/sax/features/external-parameter-entities", false);
        factory.setFeature("http://apache.org/xml/features/nonvalidating/load-external-dtd", false);
        factory.setXIncludeAware(false);
        factory.setExpandEntityReferences(false);

        DocumentBuilder builder = factory.newDocumentBuilder();
        InputSource is = new InputSource(new StringReader(xmlData));
        return builder.parse(is);
    }

    /**
     * Using a secure XML parser (if available)
     */
    public Document parseWithSecureParser(String xmlData) throws Exception {
        // SAFE: Alternative approach - use a secure configuration
        DocumentBuilderFactory factory = DocumentBuilderFactory.newInstance();

        // Try to disable all dangerous features
        String[] dangerousFeatures = {
            "http://xml.org/sax/features/external-general-entities",
            "http://xml.org/sax/features/external-parameter-entities",
            "http://apache.org/xml/features/nonvalidating/load-external-dtd"
        };

        for (String feature : dangerousFeatures) {
            try {
                factory.setFeature(feature, false);
            } catch (ParserConfigurationException e) {
                // Feature not supported, continue
            }
        }

        // Also set these attributes if supported
        factory.setAttribute("http://apache.org/xml/features/disallow-doctype-decl", true);
        factory.setAttribute("http://javax.xml.XMLConstants/property/accessExternalDTD", "");
        factory.setAttribute("http://javax.xml.XMLConstants/property/accessExternalSchema", "");

        DocumentBuilder builder = factory.newDocumentBuilder();
        InputSource is = new InputSource(new StringReader(xmlData));
        return builder.parse(is);
    }

    /**
     * Example XML data that could be exploited
     */
    public String getMaliciousXML() {
        return "<?xml version=\"1.0\"?>\n" +
               "<!DOCTYPE foo [\n" +
               "<!ELEMENT foo ANY >\n" +
               "<!ENTITY xxe SYSTEM \"file:///etc/passwd\" >]>\n" +
               "<foo>&xxe;</foo>";
    }

    /**
     * Another XXE example for SSRF
     */
    public String getSSRFXML() {
        return "<?xml version=\"1.0\"?>\n" +
               "<!DOCTYPE foo [\n" +
               "<!ELEMENT foo ANY >\n" +
               "<!ENTITY xxe SYSTEM \"http://internal-server:8080/secret\" >]>\n" +
               "<foo>&xxe;</foo>";
    }
}